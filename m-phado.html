<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <form id="loginForm">
        <label>Email</label>
        <input id="login_email" type="email" required>
        <label>Password</label>
        <input id="login_password" type="password" required>
        <button type="submit">Đăng nhập</button>
    </form>
    <hr>
    <form id="createTreeForm" style="display:none">
        <label>Name</label>
        <input id="name_tree" type="text">
        <label>Description</label>
        <input id="descrip_tree" type="text">
        <label>Public</label>
        <input id="bool_tree" type="checkbox">
        <button type="submit">Khởi tạo tree</button>
    </form>
    <div id="treeList" style="display:none">
        <h3>Danh sách cây đã tạo</h3>
        <ul id="treesUl"></ul>
    </div>
    <script type="module">
        import {
            db,
            collection,
            doc,
            setDoc,
            getDocs,
            serverTimestamp
        } from "../js/firebase/firebase-config.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const auth = getAuth();

        document.getElementById("loginForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const email = document.getElementById("login_email").value.trim();
            const password = document.getElementById("login_password").value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                alert("Đăng nhập thành công!");
            } catch (error) {
                alert("Đăng nhập thất bại: " + error.message);
            }
        });

        // Kiểm tra trạng thái đăng nhập để ẩn/hiện form
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("loginForm").style.display = "none";
                document.getElementById("createTreeForm").style.display = "block";
                document.getElementById("treeList").style.display = "block";
                loadTrees();
            } else {
                document.getElementById("loginForm").style.display = "block";
                document.getElementById("createTreeForm").style.display = "none";
                document.getElementById("treeList").style.display = "none";
            }
        });

        document.getElementById("createTreeForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const name = document.getElementById("name_tree").value.trim();
            const description = document.getElementById("descrip_tree").value.trim();
            const isPublic = document.getElementById("bool_tree").checked;
            await createTree({ name, description, isPublic });
            await loadTrees();
        });

        async function createTree({ name, description, isPublic }) {
            try {
                const treesRef = collection(db, "trees");
                const treeDocRef = doc(treesRef); // random id
                const accessCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                await setDoc(treeDocRef, {
                    name,
                    description,
                    isPublic,
                    accessCode,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                alert("Tạo cây thành công! ID: " + treeDocRef.id);
                return treeDocRef.id;
            } catch (error) {
                alert("Lỗi tạo cây phả hệ: " + error.message);
                return null;
            }
        }

        // Hiển thị danh sách các tree đã tạo
        async function loadTrees() {
            const treesUl = document.getElementById("treesUl");
            treesUl.innerHTML = "Đang tải...";
            try {
                const treesRef = collection(db, "trees");
                const snapshot = await getDocs(treesRef);
                treesUl.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const li = document.createElement("li");
                    li.textContent = `${docSnap.data().name} (ID: ${docSnap.id})`;
                    // Thêm nút để tạo member, event, permission cho tree này
                    const btnMember = document.createElement("button");
                    btnMember.textContent = "Thêm member";
                    btnMember.onclick = () => addMember(docSnap.id);
                    const btnEvent = document.createElement("button");
                    btnEvent.textContent = "Thêm event";
                    btnEvent.onclick = () => addEvent(docSnap.id);
                    const btnPermission = document.createElement("button");
                    btnPermission.textContent = "Thêm permission";
                    btnPermission.onclick = () => addPermission(docSnap.id);
                    // Thêm nút xem members
                    const btnShowMembers = document.createElement("button");
                    btnShowMembers.textContent = "Xem members";
                    btnShowMembers.onclick = () => showMembers(docSnap.id);
                    li.appendChild(btnMember);
                    li.appendChild(btnEvent);
                    li.appendChild(btnPermission);
                    li.appendChild(btnShowMembers);
                    treesUl.appendChild(li);
                });
            } catch (error) {
                treesUl.innerHTML = "Lỗi tải cây: " + error.message;
            }
        }

        // Function tạo member cho tree
        async function addMember(treeId) {
            const memberId = crypto.randomUUID();
            const memberData = {
                userId: auth.currentUser.uid,
                fullname: prompt("Tên thành viên?"),
                gender: prompt("Giới tính? (male/female)"),
                dateOfBirth: prompt("Ngày sinh?"),
                dateOfDeath: prompt("Ngày mất? (bỏ trống nếu còn sống)"),
                photoUrl: prompt("Link ảnh? (bỏ trống nếu không có)"),
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };
            const memberRef = doc(collection(db, `trees/${treeId}/members`), memberId);
            await setDoc(memberRef, memberData);
            alert("Đã thêm member cho tree " + treeId);
        }

        // Function tạo event cho tree
        async function addEvent(treeId) {
            const eventId = crypto.randomUUID();
            const eventData = {
                name: prompt("Tên sự kiện?"),
                date: prompt("Ngày diễn ra?"),
                location: prompt("Địa điểm?"),
                notification: prompt("Thông báo?"),
                description: prompt("Mô tả?"),
            };
            const eventRef = doc(collection(db, `trees/${treeId}/events`), eventId);
            await setDoc(eventRef, eventData);
            alert("Đã thêm event cho tree " + treeId);
        }

        // Function tạo permission cho tree
        async function addPermission(treeId) {
            const userId = prompt("UserId cần cấp quyền?");
            const permission = prompt("Quyền (owner/editor/viewer)?");
            const permissionRef = doc(collection(db, `trees/${treeId}/permissions`), userId);
            await setDoc(permissionRef, { permission });
            alert("Đã thêm permission cho tree " + treeId);
        }

        // Hiển thị danh sách members cho tree
        async function showMembers(treeId) {
            // Xóa popup cũ nếu có
            let oldPopup = document.getElementById("membersPopup");
            if (oldPopup) oldPopup.remove();
            const popup = document.createElement("div");
            popup.id = "membersPopup";
            popup.style.position = "fixed";
            popup.style.top = "10%";
            popup.style.left = "50%";
            popup.style.transform = "translateX(-50%)";
            popup.style.background = "#fff";
            popup.style.border = "1px solid #ccc";
            popup.style.padding = "20px";
            popup.style.zIndex = 1000;
            popup.innerHTML = `<h4>Danh sách members</h4><ul id='membersUl'></ul><button id='closeMembersPopup'>Đóng</button>`;
            document.body.appendChild(popup);
            document.getElementById("closeMembersPopup").onclick = () => popup.remove();
            const membersUl = popup.querySelector("#membersUl");
            membersUl.innerHTML = "Đang tải...";
            try {
                const membersRef = collection(db, `trees/${treeId}/members`);
                const snapshot = await getDocs(membersRef);
                membersUl.innerHTML = "";
                snapshot.forEach(docSnap => {
                    const li = document.createElement("li");
                    li.textContent = `${docSnap.data().fullname} (ID: ${docSnap.id})`;
                    // Nút tạo quan hệ
                    const btnRel = document.createElement("button");
                    btnRel.textContent = "Tạo quan hệ";
                    btnRel.onclick = () => showRelationshipForm(treeId, docSnap.id, docSnap.data().fullname);
                    li.appendChild(btnRel);
                    membersUl.appendChild(li);
                });
            } catch (error) {
                membersUl.innerHTML = "Lỗi tải members: " + error.message;
            }
        }

        // Hiển thị form tạo quan hệ cho member
        async function showRelationshipForm(treeId, memberId, memberName) {
            // Xóa popup cũ nếu có
            let oldPopup = document.getElementById("relationshipPopup");
            if (oldPopup) oldPopup.remove();
            const popup = document.createElement("div");
            popup.id = "relationshipPopup";
            popup.style.position = "fixed";
            popup.style.top = "20%";
            popup.style.left = "50%";
            popup.style.transform = "translateX(-50%)";
            popup.style.background = "#fff";
            popup.style.border = "1px solid #ccc";
            popup.style.padding = "20px";
            popup.style.zIndex = 1001;
            popup.innerHTML = `<h4>Tạo quan hệ cho ${memberName}</h4><form id='relForm'>
                <label>Loại quan hệ</label>
                <select id='relationNameSelect'></select><br>
                <label>Chọn thành viên liên quan</label>
                <select id='relativeIdSelect'></select><br>
                <div id='marriageFields' style='display:none'>
                    <label>Ngày kết hôn</label><input id='marriageDate' type='text'><br>
                    <label>Tình trạng hôn nhân</label><input id='marriageStatus' type='text'><br>
                </div>
                <button type='submit'>Tạo quan hệ</button>
                <button type='button' id='closeRelPopup'>Hủy</button>
            </form>`;
            document.body.appendChild(popup);
            document.getElementById("closeRelPopup").onclick = () => popup.remove();
            // Lấy các quan hệ đã có
            const relRef = collection(db, `trees/${treeId}/members/${memberId}/relationships`);
            const relSnap = await getDocs(relRef);
            const usedRelations = [];
            relSnap.forEach(doc => {
                if (doc.data().relationName) usedRelations.push(doc.data().relationName);
            });
            // Các option quan hệ
            const allRelations = ["cha", "mẹ", "vợ", "chồng"];
            const availableRelations = allRelations.filter(r => !usedRelations.includes(r));
            const relationSelect = document.getElementById("relationNameSelect");
            relationSelect.innerHTML = availableRelations.map(r => `<option value='${r}'>${r}</option>`).join("");
            // Lấy danh sách member khác
            const membersRef = collection(db, `trees/${treeId}/members`);
            const membersSnap = await getDocs(membersRef);
            const relativeSelect = document.getElementById("relativeIdSelect");
            relativeSelect.innerHTML = "";
            membersSnap.forEach(doc => {
                if (doc.id !== memberId) {
                    relativeSelect.innerHTML += `<option value='${doc.id}'>${doc.data().fullname} (ID: ${doc.id})</option>`;
                }
            });
            // Hiện/ẩn trường kết hôn
            function updateMarriageFields() {
                const val = relationSelect.value;
                document.getElementById("marriageFields").style.display = (val === "vợ" || val === "chồng") ? "block" : "none";
            }
            relationSelect.onchange = updateMarriageFields;
            updateMarriageFields();
            // Submit form
            document.getElementById("relForm").onsubmit = async function(e) {
                e.preventDefault();
                const relationName = relationSelect.value;
                const relativeId = relativeSelect.value;
                let marriageDate = null, marriageStatus = null;
                if (relationName === "vợ" || relationName === "chồng") {
                    marriageDate = document.getElementById("marriageDate").value;
                    marriageStatus = document.getElementById("marriageStatus").value;
                }
                await addRelationship(treeId, memberId, {relativeId, relationName, marriageDate, marriageStatus});
                alert("Đã tạo quan hệ!");
                popup.remove();
            };
        }

        // Sửa lại addRelationship để nhận data
        async function addRelationship(treeId, memberId, data) {
            const relationshipId = crypto.randomUUID();
            const relationshipData = {
                relativeId: data.relativeId,
                relationName: data.relationName,
                marriageDate: data.marriageDate || null,
                marriageStatus: data.marriageStatus || null,
            };
            const relRef = doc(collection(db, `trees/${treeId}/members/${memberId}/relationships`), relationshipId);
            await setDoc(relRef, relationshipData);
        }
    </script>
</body>
</html>